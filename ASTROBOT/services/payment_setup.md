Настройка платежной системы Cryptomus
Этот документ описывает процесс настройки и интеграции платежной системы Cryptomus в Telegram бота.
Регистрация и получение API ключей
Зарегистрируйтесь на сайте Cryptomus
После регистрации перейдите в личный кабинет
В разделе API создайте новые ключи:
Payment API key (Ключ для API платежей)
Merchant ID (Идентификатор мерчанта, обычно это UID вашего аккаунта)
Добавьте полученные ключи в файл config.py:
python

Copy
CRYPTOMUS_MERCHANT_ID = "ваш_merchant_id"
CRYPTOMUS_PAYMENT_API_KEY = "ваш_payment_api_key"
Настройка вебхуков
Для получения уведомлений о статусе платежей в реальном времени необходимо настроить вебхуки:
Запустите сервер вебхуков на вашем сервере:

Copy
python webhook.py
Настройте публичный URL для вашего вебхука. Вы можете использовать:
Собственный домен с SSL-сертификатом
Nginx в качестве обратного прокси
Сервисы для туннелирования, такие как ngrok (для тестирования)
Обновите URL вебхука в функции create_payment в файле services/cryptomus.py:
python

Copy
"callback_url": "https://ваш-домен.com/webhook",
Настройка параметров подписки
Настройте параметры подписки в файле config.py:
python

Copy
# Настройки подписки
SUBSCRIPTION_PRICE = 10.00  # Цена подписки в долларах США
SUBSCRIPTION_CURRENCY = "USD"  # Валюта для оплаты (USD, EUR, RUB и т.д.)
SUBSCRIPTION_DURATION_DAYS = 30  # Продолжительность подписки в днях
Тестирование платежей
Запустите бота:

Copy
python main.py
В Telegram отправьте команду /payment или выберите раздел "Подписка"
Нажмите на кнопку "Оплатить подписку"
Перейдите по созданной ссылке оплаты
Оплатите тестовый платеж с помощью поддерживаемой криптовалюты
После успешной оплаты вы получите уведомление через вебхук, и подписка будет автоматически активирована
Типы уведомлений о статусе платежа
Cryptomus отправляет уведомления со следующими статусами:
waiting — ожидание оплаты
paid — успешная оплата
canceled — платеж отменен
expired — истек срок действия платежа
Дополнительные настройки
Безопасность
Используйте HTTPS для вебхуков
Всегда проверяйте подпись запросов от Cryptomus
Храните API ключи в безопасном месте
Режим тестирования
Для тестирования вы можете добавить функцию, которая активирует подписку без оплаты:
python

Copy
@router.message(Command("test_activate"))
async def cmd_test_activate(message: Message):
    """
    Тестовая команда для активации подписки без оплаты.
    Доступна только администратору бота.
    """
    # Проверка, является ли пользователь администратором
    if message.from_user.id == ADMIN_USER_ID:  # Добавьте ADMIN_USER_ID в config.py
        activate_subscription(message.from_user.id)
        await message.answer("Подписка активирована в тестовом режиме!")
    else:
        await message.answer("Эта команда доступна только администратору.")
Обработка ошибок
Добавьте логирование ошибок при работе с API
Предусмотрите механизм повторных попыток для неудачных запросов
Реализуйте уведомления администратора о проблемах с платежами