"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–•—å—é–º–∞–Ω –¥–∏–∑–∞–π–Ω".
–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API Holos –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é RAG.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
"""

from aiogram import Router
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
from handlers.consultation_mode import get_end_consultation_keyboard
from services.db import (
    get_user_balance, 
    subtract_from_balance, 
    get_user_profile, 
    save_message,
    user_has_initial_analysis,
    mark_initial_analysis_completed
    
)
from services.holos_api import send_request_to_holos
from services.rag_utils import answer_with_rag, count_tokens
from logger import handlers_logger as logger
from logger import log_tokens

from config import (
    HOLOS_DREAM_URL, 
    TOKEN_PRICE, 
    MIN_REQUIRED_BALANCE,
    HD_ANALYSIS_TOKENS
)

router = Router()

router.message(lambda msg: msg.text and msg.text.lower() == "—Ö—å—é–º–∞–Ω –¥–∏–∑–∞–π–Ω")
async def handle_human_design(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–•—å—é–º–∞–Ω –¥–∏–∑–∞–π–Ω".
    –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API Holos,
    –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é RAG. –°–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑.
    
    Args:
        message (Message): –°–æ–æ–±—â–µ–Ω–∏–µ Telegram
        state (FSMContext): –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
    """
    user_id = message.from_user.id
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ Human Design
    hd_cost = HD_ANALYSIS_TOKENS * TOKEN_PRICE
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
    balance = get_user_balance(user_id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    logger.debug(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ HD: user_id={user_id}, –±–∞–ª–∞–Ω—Å={balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è={hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    
    if balance < hd_cost:
        # –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å
        logger.warning(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Human Design")
        builder = InlineKeyboardBuilder()
        builder.button(
            text=f"–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",
            callback_data="deposit_balance"
        )
        await message.answer(
            f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Human Design!\n\n"
            f"–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞: {hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n"
            f"–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞.",
            reply_markup=builder.as_markup()
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = get_user_profile(user_id)
    if not profile:
        logger.warning(f"–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω")
        await message.answer(
            "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω. –î–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–µ—Ä–∏—Ç–µ '–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ' –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /start."
        )
        return

    # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑ Human Design
    success = subtract_from_balance(
        user_id, 
        hd_cost, 
        f"–ê–Ω–∞–ª–∏–∑ Human Design ({HD_ANALYSIS_TOKENS} —Ç–æ–∫–µ–Ω–æ–≤)"
    )
    
    if not success:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        await message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        return
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤
    logger.info(f"–°–ø–∏—Å–∞–Ω–æ {hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤ –∑–∞ –∞–Ω–∞–ª–∏–∑ HD –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    await message.answer(
        f"üí∏ –° –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Å–ø–∏—Å–∞–Ω–æ {hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤ –∑–∞ –∞–Ω–∞–ª–∏–∑ Human Design.\n"
        f"–í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
    date_str = f"{profile['birth_date']} {profile['birth_time']}"  # —Ñ–æ—Ä–º–∞—Ç: –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú
    latitude = profile["latitude"]
    longitude = profile["longitude"]
    altitude = profile["altitude"]

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API Holos
    logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API Holos –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    response_data = await send_request_to_holos(
        holos_url=HOLOS_DREAM_URL,
        date_str=date_str,
        latitude=latitude,
        longitude=longitude,
        altitude=altitude
    )
    
    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
    user_profile_info = (
        f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_date']}\n"
        f"–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_time']}\n"
        f"–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã): {latitude}, {longitude}, {altitude}\n"
        f"–î–∞–Ω–Ω—ã–µ API: {response_data}"
    )
    
    holos_data_combined = {
        "user_profile": user_profile_info,
        "api_response": response_data
    }
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –ø—Ä–æ–≤–µ–¥–µ–Ω –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    is_initial_analysis = not user_has_initial_analysis(user_id)
    logger.debug(f"–ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {'–ù–ï –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è (–±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω)' if is_initial_analysis else '–£–ñ–ï –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è (–±—É–¥–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)'}")
    
    # –ï–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –ø–µ—Ä–≤–∏—á–Ω—ã–π —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ –∏–ª–∏ –Ω–µ—Ç
    expert_prompt = """
            –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö API.
            –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã API-–æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–Ω–∏—è —Ç–∏–ø–∞ –ª–∏—á–Ω–æ—Å—Ç–∏:
            - 'type' - –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ (manifestor, projector, generator, mangenerator, reflector)
            - 'profile' - –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4/1)
            - 'authority' - –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, splenic, emotional)

            –≠—Ç–∏ –ø–æ–ª—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –æ–±—ä–µ–∫—Ç–∞ data API-–æ—Ç–≤–µ—Ç–∞.
            –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–∏–ø, –∞ –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑–∞–Ω –≤ –ø–æ–ª–µ 'type'.

            –ü–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞, –æ–±—ä—è—Å–Ω–∏ 1-2 –∫–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –∞ –∑–∞—Ç–µ–º –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –¥—Ä—É–≥–∏–º–∏ –ª—é–¥—å–º–∏.
    
            –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–∏—á–Ω–æ—Å—Ç–∏, –≤—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç:

            –°–∫–∞–∂–∏, –∫–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å —Ç—ã –±—ã —Ö–æ—Ç–µ–ª —Å–µ–π—á–∞—Å –æ–±—Å—É–¥–∏—Ç—å? –î–ª—è —Ç–µ–±—è —Å–µ–π—á–∞—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–µ–º–µ–π–Ω—ã–µ, —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ, —Ä–∞–±–æ—á–∏–µ –∏–ª–∏, –º–æ–∂–µ—Ç –±—ã—Ç—å, –¥—Ä—É–∂–µ—Å–∫–∏–µ? –ò–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ –ª–∏—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö?
            
            –Ø –º–æ–≥—É –ø–æ–º–æ—á—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ç–∞–∫–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö:
            1. –ö–∞–∫ –Ω–∞–ª–∞–¥–∏—Ç—å –æ–±—â–µ–Ω–∏–µ –∏ –∏–∑–±–µ–≥–∞—Ç—å –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è —Å –±–ª–∏–∑–∫–∏–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏.
            2. –ö–∞–∫ –º—è–≥–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —Ç–µ–±—è —É–≤–∞–∂–∞–ª–∏, –Ω–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –Ω–µ –ø–æ—Ä—Ç–∏–ª–∏—Å—å.
            3. –ö–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –¥—Ä—É–∂–±—É –∏–ª–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–Ω–æ—Å–∏–ª–∏ —Ä–∞–¥–æ—Å—Ç—å.
            4. –ü–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ–Ω—è—Ç—å —Å–≤–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ.
            5. –ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.

            –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –∞–∫—Ç—É–∞–ª—å–Ω–æ ‚Äî –∏ —è –¥–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏! –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º –ø—Ä—è–º–æ –≤ —á–∞—Ç! –ï—Å–ª–∏ –∂–µ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ç–µ–º—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏" –∏ —è –ø—Ä–µ–¥–ª–æ–∂—É –Ω–∞ –≤—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
       """

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –æ—Ç–º–µ—á–∞–µ–º —ç—Ç–æ –≤ –ë–î
    if is_initial_analysis:
        mark_initial_analysis_completed(user_id)
        logger.info(f"–û—Ç–º–µ—á–µ–Ω–æ, —á—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
   
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é RAG - —É–±—Ä–∞–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä type_shown
    logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å RAG –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    expert_comment = answer_with_rag(
        expert_prompt,
        holos_data_combined,
        mode="free",
        conversation_history="",
        max_tokens=1200
    )
   
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    save_message(user_id, 'bot', expert_comment)
    logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    if len(expert_comment) > 4096:
        chunk_size = 4096
        logger.debug(f"–û—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ({len(expert_comment)} —Å–∏–º–≤–æ–ª–æ–≤), —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏")
        for i in range(0, len(expert_comment), chunk_size):
            await message.answer(expert_comment[i:i+chunk_size])
    else:
        await message.answer(expert_comment)
   
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ —Å–æ–æ–±—â–∞–µ–º –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
    new_balance = get_user_balance(user_id)
    logger.info(f"–ê–Ω–∞–ª–∏–∑ HD –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {new_balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    await message.answer(
        f"–ê–Ω–∞–ª–∏–∑ Human Design –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n"
        f"üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {new_balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤ \n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ. "
        "–ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –±—É–¥—É—Ç —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤.",
        reply_markup=get_end_consultation_keyboard()
    )
   
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏ –¥–∞–Ω–Ω—ã–µ API –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(
        conversation_history=f"–ë–æ—Ç: {expert_comment}\n",
        holos_response=holos_data_combined,
        in_consultation=True  # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    )