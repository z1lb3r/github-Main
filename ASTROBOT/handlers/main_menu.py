"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –±–æ—Ç–∞ –∏ –≤—Å–µ—Ö –µ–≥–æ —Ä–∞–∑–¥–µ–ª–æ–≤.
"""

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.utils.keyboard import InlineKeyboardBuilder

from .keyboards import (
    main_menu_kb, 
    get_back_to_menu_keyboard,
    get_consultation_confirmation_keyboard
)
from services.db import get_user_balance, get_transaction_history, get_user_profile, subtract_from_balance, get_last_messages, save_message
from config import MIN_REQUIRED_BALANCE
from handlers.change_data import get_updated_main_menu_keyboard
from handlers.consultation_mode import (
    start_consultation_mode, 
    is_in_consultation,
    get_end_consultation_keyboard
)
from handlers.referral import show_referral_program_enhanced, show_ref_stats_enhanced
from services.rag_utils import answer_with_rag

router = Router()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /menu
@router.message(Command("menu"))
async def cmd_menu(message: Message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞.
    """
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", reply_markup=get_updated_main_menu_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
@router.message(F.text == "‚ú® –ù–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é")
async def start_consultation(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é".
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–ª–∞–Ω—Å, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.
    """
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    in_consultation = await is_in_consultation(state)
    print(f"–ù–∞—á–∞–ª–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: user_id={user_id}, —É–∂–µ –≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏={in_consultation}")
    
    if in_consultation:
        await message.answer(
            "–í—ã —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã "
            "–∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            reply_markup=get_end_consultation_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = get_user_profile(user_id)
    if not profile:
        await message.answer(
            "–î–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.",
            reply_markup=get_updated_main_menu_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    balance = get_user_balance(user_id)
    print(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: user_id={user_id}, –±–∞–ª–∞–Ω—Å={balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤, –º–∏–Ω–∏–º—É–º={MIN_REQUIRED_BALANCE:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    
    if balance < MIN_REQUIRED_BALANCE:
        await message.answer(
            f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\n\n"
            f"–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤ \n"
            f"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: {MIN_REQUIRED_BALANCE:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ —Ä–∞–∑–¥–µ–ª–µ '–ë–∞–ª–∞–Ω—Å'.",
            reply_markup=get_updated_main_menu_keyboard()
        )
        return
    
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
    await message.answer(
        "üîÆ –í—ã –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ Human Design?\n\n"
        "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ "
        "–¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.\n\n"
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞: {MIN_REQUIRED_BALANCE:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n"
        f"–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤",
        reply_markup=get_consultation_confirmation_keyboard()
    )

# –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
@router.message(F.text == "üîÑ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é")
async def continue_consultation(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é".
    –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ä–µ–∂–∏–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥.
    """
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    in_consultation = await is_in_consultation(state)
    print(f"–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: user_id={user_id}, —É–∂–µ –≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏={in_consultation}")
    
    if in_consultation:
        await message.answer(
            "–í—ã —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.",
            reply_markup=get_end_consultation_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = get_user_profile(user_id)
    if not profile:
        await message.answer(
            "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.",
            reply_markup=get_updated_main_menu_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    balance = get_user_balance(user_id)
    print(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: user_id={user_id}, –±–∞–ª–∞–Ω—Å={balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤, –º–∏–Ω–∏–º—É–º={MIN_REQUIRED_BALANCE:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    
    if balance < MIN_REQUIRED_BALANCE:
        await message.answer(
            f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\n\n"
            f"–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤ \n"
            f"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: {MIN_REQUIRED_BALANCE:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ —Ä–∞–∑–¥–µ–ª–µ '–ë–∞–ª–∞–Ω—Å'.",
            reply_markup=get_updated_main_menu_keyboard()
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    messages = get_last_messages(user_id, 10)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    if not messages:
        await message.answer(
            "–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ '–ù–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é' –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.",
            reply_markup=get_updated_main_menu_keyboard()
        )
        return
        
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    await start_consultation_mode(user_id, state)
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    holos_response = data.get("holos_response", {})
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–æ–∫–∞–∑–∞–Ω —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–Ω–µ–µ
    type_shown = data.get("type_shown", False)
    
    # –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –∑–Ω–∞—á–∏—Ç —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ —É–∂–µ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
    if messages and not type_shown:
        type_shown = True
        await state.update_data(type_shown=type_shown)
    
    # –ï—Å–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö holos_response, –ø–æ–ª—É—á–∞–µ–º –∏—Ö –∑–∞–Ω–æ–≤–æ
    if not holos_response:
        from services.holos_api import send_request_to_holos
        from config import HOLOS_DREAM_URL
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
        date_str = f"{profile['birth_date']} {profile['birth_time']}"
        latitude = profile["latitude"]
        longitude = profile["longitude"]
        altitude = profile["altitude"]
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API Holos
        response_data = await send_request_to_holos(
            holos_url=HOLOS_DREAM_URL,
            date_str=date_str,
            latitude=latitude,
            longitude=longitude,
            altitude=altitude
        )
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
        user_profile_info = (
            f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_date']}\n"
            f"–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_time']}\n"
            f"–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã): {latitude}, {longitude}, {altitude}\n"
            f"–î–∞–Ω–Ω—ã–µ API: {response_data}"
        )
        
        holos_response = {
            "user_profile": user_profile_info,
            "api_response": response_data
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        await state.update_data(holos_response=holos_response)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    conversation_history = ""
    for msg in messages:
        if msg['is_summary']:
            conversation_history += f"–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞: {msg['content']}\n\n"
        else:
            prefix = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " if msg['sender'] == 'user' else "–ë–æ—Ç: "
            conversation_history += f"{prefix}{msg['content']}\n\n"
    
    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    continue_prompt = "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å. –ù–µ —É–ø–æ–º–∏–Ω–∞–π –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º, –∫–∞–∫ –±—É–¥—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å —Ä–∞–∑–≥–æ–≤–æ—Ä. –¢—ã ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–º—É–∂—á–∏–Ω–∞) –ø–æ Human Design –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π. –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞ - –Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–æ–≤–æ—Ä–∏ '—è —Ä–∞–¥', '—è –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å', –∞ –Ω–µ '—è —Ä–∞–¥–∞', '—è –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å'."
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º history –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ñ–ª–∞–≥–æ–º type_shown
    welcome_message = answer_with_rag(
        continue_prompt,
        holos_response,
        mode="free",
        conversation_history=conversation_history,
        max_tokens=500,
        type_shown=type_shown
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    save_message(user_id, 'bot', welcome_message)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    await message.answer(
        welcome_message,
        reply_markup=get_end_consultation_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ë–∞–ª–∞–Ω—Å"
@router.message(F.text == "üí∞ –ë–∞–ª–∞–Ω—Å")
async def show_balance(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ë–∞–ª–∞–Ω—Å".
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏ –æ–ø—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º.
    """
    balance = get_user_balance(message.from_user.id)
    print(f"–ü–æ–∫–∞–∑ –±–∞–ª–∞–Ω—Å–∞: user_id={message.from_user.id}, –±–∞–ª–∞–Ω—Å={balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    
    # –ó–∞–º–µ–Ω—è–µ–º get_balance_keyboard –Ω–∞ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –±–µ–∑ –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
    builder = InlineKeyboardBuilder()
    builder.button(
        text="üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",
        callback_data="deposit_balance"
    )
    builder.button(
        text="üìä –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π",
        callback_data="transaction_history"
    )
    builder.row(
        InlineKeyboardButton(text="üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")
    )
    
    await message.answer(
        f"üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n\n"
        "–ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–∞—à –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–ø–ª–∞—Ç—ã –ö–†–ï–î–ò–¢–´. –û–¥–∏–Ω –∫—Ä–µ–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–º—É —Ä—É–±–ª—é.\n\n"
        "–í —Å—Ä–µ–¥–Ω–µ–º, —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç 300 –¥–æ 1000 –∫—Ä–µ–¥–∏—Ç–æ–≤.\n\n"
        "–ë–æ—Ç —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Å –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∫—Ä–µ–¥–∏—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π. –¢–æ –µ—Å—Ç—å —á–µ–º –±–æ–ª—å—à–µ –æ–±—â–∞–µ—Ç–µ—Å—å - —Ç–µ–º –±–æ–ª—å—à–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ –í—ã —Ç—Ä–∞—Ç–∏—Ç–µ.\n\n"
        "–ï—Å–ª–∏ –í—ã –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π, —Ç–æ –¥–µ–Ω—å–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ò –µ—Å–ª–∏ –í–∞–º –Ω—É–∂–Ω–æ —É–∑–Ω–∞–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –ª–∏—à—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ—á–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Ç–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –±—É–¥–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è.\n\n"
        "–ï—Å–ª–∏ —É –í–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–ø–ª–∞—Ç–µ, —Ç–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –Ω–∞—à—É —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º: @vlad_adsmaster\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
    reply_markup=builder.as_markup()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ø–æ–ª–Ω–∏—Ç—å"
@router.callback_query(F.data == "deposit_balance")
async def deposit_balance(callback: CallbackQuery, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ø–æ–ª–Ω–∏—Ç—å".
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ CrystalPay.
    """
    await callback.answer()
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —É–∂–µ –∏–º–µ—é—â–µ–≥–æ—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    from handlers.payment import process_deposit_start
    await process_deposit_start(callback, state)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ"
@router.message(F.text == "üìã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ")
async def show_terms(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ".
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è.
    """
    terms_text = """
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ

## 1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è

–ù–∞—Å—Ç–æ—è—â–µ–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äì ¬´–°–æ–≥–ª–∞—à–µ–Ω–∏–µ¬ª) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –≤–ª–∞–¥–µ–ª—å—Ü–µ–º Telegram-–±–æ—Ç–∞ "@cz_astrobot" (–¥–∞–ª–µ–µ ‚Äì ¬´–°–µ—Ä–≤–∏—Å¬ª) –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –ª–∏—Ü–æ–º (–¥–∞–ª–µ–µ ‚Äì ¬´–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å¬ª), –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º —É—Å–ª—É–≥–∏ –°–µ—Ä–≤–∏—Å–∞.

–ò—Å–ø–æ–ª—å–∑—É—è –°–µ—Ä–≤–∏—Å, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –°–æ–≥–ª–∞—à–µ–Ω–∏—è.

## 2. –ü—Ä–µ–¥–º–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ Human Design –∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Telegram-–±–æ—Ç–∞.

## 3. –ü–æ—Ä—è–¥–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –°–µ—Ä–≤–∏—Å–∞

3.1. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –°–µ—Ä–≤–∏—Å–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è –∏–º—è, –¥–∞—Ç—É –∏ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è.

3.2. –û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥ –°–µ—Ä–≤–∏—Å–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É CrystalPay –ø–æ –º–æ–¥–µ–ª–∏ "–æ–ø–ª–∞—Ç–∞ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ" (pay-per-use).

3.3. –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏—Å—Ö–æ–¥—è –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö(1 –∫—Ä–µ–¥–∏—Ç = 1 —Ä—É–±–ª—å).

## 4. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –°—Ç–æ—Ä–æ–Ω

4.1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è:
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –°–µ—Ä–≤–∏—Å –¥–ª—è –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
- –°–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å —É—Å–ª—É–≥–∏ –°–µ—Ä–≤–∏—Å–∞

4.2. –°–µ—Ä–≤–∏—Å –æ–±—è–∑—É–µ—Ç—Å—è:
- –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ Human Design
- –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –°–µ—Ä–≤–∏—Å–∞ —Å —É—á–µ—Ç–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

## 5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

5.1. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –°–µ—Ä–≤–∏—Å–æ–º, –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

5.2. –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Ä–µ—à–µ–Ω–∏—è, –ø—Ä–∏–Ω—è—Ç—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π.

5.3. –°–µ—Ä–≤–∏—Å –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

## 6. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

6.1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–≤–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ–ª–µ–π –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥.

6.2. –°–µ—Ä–≤–∏—Å –æ–±—è–∑—É–µ—Ç—Å—è –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤, –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º.

## 7. –ü–æ—Ä—è–¥–æ–∫ –æ–ø–ª–∞—Ç—ã

7.1. –û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É CrystalPay.

7.2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ —Å–≤—è–∑–∏ –∏ –¥–æ—Å—Ç—É–ø–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

## 8. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

8.1. –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –±–µ—Å—Å—Ä–æ—á–Ω–æ –¥–æ –º–æ–º–µ–Ω—Ç–∞ –µ–≥–æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è.

8.2. –°–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑–º–µ–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –°–æ–≥–ª–∞—à–µ–Ω–∏—è. –ù–æ–≤–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è –°–æ–≥–ª–∞—à–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É —Å –º–æ–º–µ–Ω—Ç–∞ –µ–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.

## 9. –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è

9.1. –í—Å–µ —Å–ø–æ—Ä—ã –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –°–æ–≥–ª–∞—à–µ–Ω–∏—é —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è –ø—É—Ç–µ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤.

9.2. –í–æ –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–º, —á—Ç–æ –Ω–µ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Å—Ç–æ—è—â–∏–º –°–æ–≥–ª–∞—à–µ–Ω–∏–µ–º, —Å—Ç–æ—Ä–æ–Ω—ã —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É—é—Ç—Å—è –¥–µ–π—Å—Ç–≤—É—é—â–∏–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º.
"""
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
    max_length = 4000
    if len(terms_text) <= max_length:
        await message.answer(
            terms_text,
            reply_markup=get_back_to_menu_keyboard()
        )
    else:
        parts = [terms_text[i:i+max_length] for i in range(0, len(terms_text), max_length)]
        for i, part in enumerate(parts):
            if i == len(parts) - 1:  # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å
                await message.answer(
                    part,
                    reply_markup=get_back_to_menu_keyboard()
                )
            else:
                await message.answer(part)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –Ω–∞—Å"
@router.message(F.text == "‚ÑπÔ∏è –û –Ω–∞—Å")
async def show_about_us(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –Ω–∞—Å".
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ.
    """
    about_text = """
# –ê—Å—Ç—Ä–æ-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥ –≤ –º–∏—Ä–µ Human Design

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤–∞–º –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ Telegram-–±–æ—Ç–∞, —Å–æ–≤–º–µ—â–∞—é—â–µ–≥–æ –¥—Ä–µ–≤–Ω—é—é –º—É–¥—Ä–æ—Å—Ç—å –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –ø–æ —Å–∏—Å—Ç–µ–º–µ Human Design.

–ù–∞—à –±–æ—Ç ‚Äì —ç—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—å –≤–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ –Ω–∞–π—Ç–∏ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –¥–∞—Ç–µ, –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Å—Ç–µ –≤–∞—à–µ–≥–æ —Ä–æ–∂–¥–µ–Ω–∏—è, –æ–Ω —Å–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã, –≤—ã—è–≤–ª—è—è –≤–∞—à–∏ –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã, –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞.

–°–∏—Å—Ç–µ–º–∞ Human Design –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥—Ä–µ–≤–Ω–∏–µ –∑–Ω–∞–Ω–∏—è –ò-–¶–∑–∏–Ω, –ö–∞–±–±–∞–ª—ã, –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ –∏ –≥–µ–Ω–µ—Ç–∏–∫–∏ –≤ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è. –ù–∞—à –±–æ—Ç –¥–µ–ª–∞–µ—Ç —ç—Ç–∏ —Å–ª–æ–∂–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã–º–∏ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏, –ø–æ–º–æ–≥–∞—è –≤–∞–º:

- –ü–æ–Ω—è—Ç—å —Å–≤–æ–π —Ç–∏–ø —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –º–∏—Ä–æ–º
- –í—ã—è–≤–∏—Ç—å –≤–∞—à–∏ –≤—Ä–æ–∂–¥–µ–Ω–Ω—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º
- –†–∞–∑—Ä–µ—à–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã –∑–∞ –Ω–µ–ø–æ—Ö–æ–∂–µ—Å—Ç—å –Ω–∞ –¥—Ä—É–≥–∏—Ö
- –í—ã—Å—Ç—Ä–æ–∏—Ç—å –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Ä–∞–∑–ª–∏—á–∏–π

–ë–ª–∞–≥–æ–¥–∞—Ä—è –ø–µ—Ä–µ–¥–æ–≤—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –Ω–∞—à –±–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ –∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –∫–∞—Ä—å–µ—Ä–µ, –∑–¥–æ—Ä–æ–≤—å–µ –∏ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏.

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –æ–ø–ª–∞—Ç—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è —à–∏—Ä–æ–∫–æ–≥–æ –∫—Ä—É–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—ã –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–µ—Ç–µ, –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —Å–∫—Ä—ã—Ç—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π.
"""
    
    await message.answer(
        about_text,
        reply_markup=get_back_to_menu_keyboard()
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ö–æ–Ω—Ç–∞–∫—Ç—ã"
@router.message(F.text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")
async def show_contacts(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ö–æ–Ω—Ç–∞–∫—Ç—ã".
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
    """
    contacts_text = (
        "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã\n\n"
        "–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏:\n\n"
        "Telegram: @vlad_adsmaster\n\n"
        "–ë—É–¥–µ–º —Ä–∞–¥—ã –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏!"
    )
    
    await message.answer(
        contacts_text,
        reply_markup=get_back_to_menu_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞"
@router.message(F.text == "üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞")
async def show_referral_program(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞".
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.
    """
    await show_referral_program_enhanced(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ"
@router.message(F.text == "üë§ –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ")
async def handle_change_data(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ".
    """
    from handlers.change_data import change_user_data
    await change_user_data(message, state)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
@router.callback_query(F.data == "copy_ref_link")
async def copy_ref_link(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏.
    """
    # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –±–æ—Ç–∞
    bot_username = "cz_astrobot_bot"  # –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –±–æ—Ç–∞ —Å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ–º
    
    user_id = callback.from_user.id
    ref_link = f"https://t.me/{bot_username}?start={user_id}"
    
    await callback.answer("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!")
    await callback.message.answer(
        f"–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n{ref_link}\n\n"
        "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞."
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
@router.callback_query(F.data == "ref_stats")
async def show_ref_stats(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π.
    """
    await show_ref_stats_enhanced(callback)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@router.callback_query(F.data == "back_to_main_menu")
async def back_to_main_menu(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    await callback.answer()
    await callback.message.answer(
        "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_updated_main_menu_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
@router.callback_query(F.data == "start_consultation")
async def confirm_consultation(callback: CallbackQuery, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Human Design –∏ –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
    
    Args:
        callback (CallbackQuery): Callback query
        state (FSMContext): –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
    """
    await callback.answer()
    
    # –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    user_id = callback.from_user.id
    await start_consultation_mode(user_id, state)
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ HD
    from handlers.human_design import HD_ANALYSIS_TOKENS, TOKEN_PRICE, HOLOS_DREAM_URL
    from services.db import (
        get_user_balance, 
        subtract_from_balance, 
        get_user_profile, 
        save_message,
        user_has_initial_analysis,
        mark_initial_analysis_completed
    )
    from services.holos_api import send_request_to_holos
    from services.rag_utils import answer_with_rag
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ Human Design
    hd_cost = HD_ANALYSIS_TOKENS * TOKEN_PRICE
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â–µ —Ä–∞–∑
    balance = get_user_balance(user_id)
    print(f"[DEBUG] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ HD –≤ confirm_consultation: user_id={user_id}, –±–∞–ª–∞–Ω—Å={balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è={hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤")
    
    if balance < hd_cost:
        await callback.message.answer(
            f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Human Design!\n\n"
            f"–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞: {hd_cost:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n"
            f"–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.0f} –∫—Ä–µ–¥–∏—Ç–æ–≤\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞."
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = get_user_profile(user_id)
    if not profile:
        await callback.message.answer(
            "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω. –î–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–µ—Ä–∏—Ç–µ '–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ' –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /start."
        )
        return
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑ Human Design
    success = subtract_from_balance(
        user_id, 
        hd_cost, 
        f"–ê–Ω–∞–ª–∏–∑ Human Design ({HD_ANALYSIS_TOKENS} —Ç–æ–∫–µ–Ω–æ–≤)"
    )
    
    if not success:
        await callback.message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        return
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–∞—á–∞–ª–µ –∞–Ω–∞–ª–∏–∑–∞
    await callback.message.answer("–í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ Human Design, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
    date_str = f"{profile['birth_date']} {profile['birth_time']}"  # —Ñ–æ—Ä–º–∞—Ç: –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú
    latitude = profile["latitude"]
    longitude = profile["longitude"]
    altitude = profile["altitude"]

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API Holos
    response_data = await send_request_to_holos(
        holos_url=HOLOS_DREAM_URL,
        date_str=date_str,
        latitude=latitude,
        longitude=longitude,
        altitude=altitude
    )
    
    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
    user_profile_info = (
        f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_date']}\n"
        f"–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {profile['birth_time']}\n"
        f"–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã): {latitude}, {longitude}, {altitude}\n"
        f"–î–∞–Ω–Ω—ã–µ API: {response_data}"
    )
    
    holos_data_combined = {
        "user_profile": user_profile_info,
        "api_response": response_data
    }
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –ø—Ä–æ–≤–µ–¥–µ–Ω –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    is_initial_analysis = not user_has_initial_analysis(user_id)
    print(f"[DEBUG] –ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {'–ù–ï –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è (–±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω)' if is_initial_analysis else '–£–ñ–ï –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è (–±—É–¥–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)'}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    type_shown = data.get("type_shown", False)
    
    # –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
    expert_prompt = """
    –û–ø—Ä–µ–¥–µ–ª–∏ –º–æ–π —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞, –ø—Ä–æ—Ñ–∏–ª—è, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞) –∏ –¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (1-2 –∞–±–∑–∞—Ü–∞ –º–∞–∫—Å–∏–º—É–º).
    
    –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–∏—á–Ω–æ—Å—Ç–∏, –≤—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç:

    –°–∫–∞–∂–∏, –∫–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å —Ç—ã –±—ã —Ö–æ—Ç–µ–ª —Å–µ–π—á–∞—Å –æ–±—Å—É–¥–∏—Ç—å? –î–ª—è —Ç–µ–±—è —Å–µ–π—á–∞—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–µ–º–µ–π–Ω—ã–µ, —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ, —Ä–∞–±–æ—á–∏–µ –∏–ª–∏, –º–æ–∂–µ—Ç –±—ã—Ç—å, –¥—Ä—É–∂–µ—Å–∫–∏–µ? –ò–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ –ª–∏—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö?
    
    –Ø –º–æ–≥—É –ø–æ–º–æ—á—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ç–∞–∫–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö:
    1. –ö–∞–∫ –Ω–∞–ª–∞–¥–∏—Ç—å –æ–±—â–µ–Ω–∏–µ –∏ –∏–∑–±–µ–≥–∞—Ç—å –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è —Å –±–ª–∏–∑–∫–∏–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏.
    2. –ö–∞–∫ –º—è–≥–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —Ç–µ–±—è —É–≤–∞–∂–∞–ª–∏, –Ω–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –Ω–µ –ø–æ—Ä—Ç–∏–ª–∏—Å—å.
    3. –ö–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –¥—Ä—É–∂–±—É –∏–ª–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–Ω–æ—Å–∏–ª–∏ —Ä–∞–¥–æ—Å—Ç—å.
    4. –ü–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ–Ω—è—Ç—å —Å–≤–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ.
    5. –ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.
    
    –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –∞–∫—Ç—É–∞–ª—å–Ω–æ ‚Äî –∏ —è –¥–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏! –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º –ø—Ä—è–º–æ –≤ —á–∞—Ç! –ï—Å–ª–∏ –∂–µ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ç–µ–º—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏" –∏ —è –ø—Ä–µ–¥–ª–æ–∂—É –Ω–∞ –≤—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
    """
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –æ—Ç–º–µ—á–∞–µ–º —ç—Ç–æ –≤ –ë–î
    if is_initial_analysis:
        mark_initial_analysis_completed(user_id)
        print(f"[DEBUG] –û—Ç–º–µ—á–µ–Ω–æ, —á—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é RAG, –ø–µ—Ä–µ–¥–∞–≤–∞—è —Ñ–ª–∞–≥ type_shown
    expert_comment = answer_with_rag(
        expert_prompt,
        holos_data_combined,
        mode="free",
        conversation_history="",
        max_tokens=3000,
        type_shown=type_shown
    )
    
    # –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Ç–∏–ø –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
    if not type_shown:
        await state.update_data(type_shown=True)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    save_message(user_id, 'bot', expert_comment)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    if len(expert_comment) > 4096:
        chunk_size = 4096
        for i in range(0, len(expert_comment), chunk_size):
            await callback.message.answer(expert_comment[i:i+chunk_size])
    else:
        await callback.message.answer(expert_comment)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(
        conversation_history=f"–ë–æ—Ç: {expert_comment}\n",
        holos_response=holos_data_combined,
        in_consultation=True
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    await callback.message.answer(
        "–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, –Ω–∞–∂–º–∏—Ç–µ '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é':", 
        reply_markup=get_end_consultation_keyboard()
    )